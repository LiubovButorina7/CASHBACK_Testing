# Тестирование кэшбэка

### Условия начисления кэшбэка
1. Типы транзакций, по которым начисляется кэшбэк, указаны в настройке CASHBACK_TYPES. На момент запуска это типы с кодами: TRANZ_1, TRANZ_2, TRANZ_8, TRANZ_17, TRANZ_19. 
2.	Кэшбэк начисляется только по клиентам, у которых подключена акция CASHBACK.
3.	В настройке CASHBACK_EXCEPTION перечислены MCC исключенные из расчета. На момент запуска MCC: 4812, 4813, 4814, 4816, 4829, 4900, 6012, 6050.
4.	MCC для начисления повышенного кэшбэка указываются в настройке CASHBACK_VALUE. На момент запуска: 5339, 5621.

### Расчет суммы кэшбэка

Базовая ставка - 0,5% на покупки от 100 рублей. При этом сумма покупки округляется вниз до кратной 100. Если клиент купил товар на 390 рублей, получит 300*0,5=1,5 кэшбэка. Если на 420 - получит 400*0,5%=2 рубля. На 1100 - получит 5,5;

Повышенная - 5% на покупки от 100 рублей по некоторым категориям МСС. При этом сумма покупки округляется вниз до кратной 100.  Например, покупка по МСС 5339 на 740 рублей - 35 рублей кэшбэка;

Максимальная сумма кэшбэка по одной карте в месяц - 3 000 руб. Если транзакция попала в расчет, но сумма кэшбэка по карте превышает 3 000 руб., рассчитываем кэшбэк на сумму, не превышающую максимальный лимит (сумма может равняться 0);

Если у клиента на момент совершения транзакции по карте установлена отметка ПОД/ФТ, сумма рассчитанного кэшбэка = 0.

### Учет кэшбэка

1.  Учет кэшбэка осуществляется операцией "Учет начисленного кэшбэка", которая автоматически запускается в последний день месяца. 
2.	Операция считает общую сумму накопленного за месяц кэшбэка и перечисляет его общей суммой на счет 47422. 
3.	Сумма учтенного кэшбэка заполняется в реквизите "Учтенный кэшбэк";
4.	В выборку попадают операции текущего месяца из справочника "Кэшбэк по картам":
  -	Дата проводки в текущем календарном месяце;
  - Признак исключения из кэшбэка = Нет;
  - CashBack выплачен = Нет.
5.	В результате формируется платежный документ: Дт 70606 (счет расходов Банка) Кт 47422 (обязательства по выплате кэшбэка). Назначение платежа: "Начисление кэшбэка по операциям с использованием пластиковых карт Банка за [месяц] [год]".
6.	Если клиент отказался от кэшбэка (отключил акцию без выплаты кэшбэка на счет):
  - Весь накопленный, невыплаченный и неучтенный кэшбэк "сгорает". В справочнике "Кэшбэк по картам" проставляем "Признак исключения из кэшбэка" = Да. 
  -	Весь накопленный, невыплаченный и учтенный на 47422 кэшбэк "сгорает" и переходит в счет доходов банка. Формируется платежный документ Дт 47422 (обязательства по выплате кэшбэка) Кт 70606 (счет расходов Банка). Назначение платежа: "Списание невостребованного кэшбэка по операциям с использованием пластиковых карт Банка в связи с отказом клиента за период с [месяц] [год] по [месяц] [год]." 

### Выплата кэшбэка

Для выплаты доступен только учтенный кэшбэк за предыдущие календарные месяцы. Например, в декабре клиент может забрать кэшбэк за октябрь и более ранние месяцы.

После выплаты кэшбэка у записей в справочнике "Кэшбэк по картам" устанавливается признак "Выплачен" = Да.

Система выплачивает весь доступный к выплате кэшбэк одной суммой на расчетный счет клиента.  При этом клиент не может выбрать какую сумму и на какой счет ему выплатить.

Формируется платежный документ: Дт 47422 (обязательства по выплате кэшбэка) Кт 40802 (расчетный счет клиента).

## Задание: 

- написать чек-лист проведения тестирования https://docs.google.com/spreadsheets/d/1pDCkcFpkoqBJpJJVoy3jVNv4A3VoajUeWfCjE374duQ/edit?usp=sharing
